#!/bin/bash
# Update system packages
yum update -y

# Install NGINX, PHP, and PHP-FPM
yum install -y nginx php php-fpm

# Start and enable NGINX and PHP-FPM
systemctl start nginx
systemctl enable nginx
systemctl start php-fpm
systemctl enable php-fpm

# Configure PHP-FPM to work with NGINX
sed -i 's/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/' /etc/php.ini
sed -i 's/user = apache/user = nginx/' /etc/php-fpm.d/www.conf
sed -i 's/group = apache/group = nginx/' /etc/php-fpm.d/www.conf
sed -i 's/127.0.0.1:9000/unix:\/run\/php-fpm\/php-fpm.sock/' /etc/php-fpm.d/www.conf

# Restart PHP-FPM after configuration changes
systemctl restart php-fpm

# Configure NGINX default server block to handle PHP
cat << 'EOF' > /etc/nginx/conf.d/default.conf
server {
    listen       80;
    server_name  _;
    root         /usr/share/nginx/html;
    index        index.php index.html;

    location / {
        try_files $uri $uri/ =404;
    }

    location ~ \.php$ {
        include        fastcgi_params;
        fastcgi_pass   unix:/run/php-fpm/php-fpm.sock;
        fastcgi_index  index.php;
        fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
    }

    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
EOF

# Restart NGINX to apply configuration
systemctl restart nginx

# Create HTML home page
cat << 'EOF' > /usr/share/nginx/html/index.html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My AWS Practice Server</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #232f3e, #37475a);
      color: white;
    }
    header {
      padding: 20px;
      background: #131a22;
    }
    header img {
      height: 60px;
    }
    h1 {
      margin-top: 40px;
      font-size: 2.5em;
      color: #ff9900;
    }
    p {
      font-size: 18px;
      color: #ddd;
    }
    .btn {
      display: inline-block;
      margin-top: 20px;
      padding: 12px 25px;
      font-size: 16px;
      color: #fff;
      background-color: #ff9900;
      border: none;
      border-radius: 5px;
      text-decoration: none;
      transition: background 0.3s ease;
    }
    .btn:hover {
      background-color: #e68a00;
    }
    footer {
      margin-top: 50px;
      padding: 10px;
      background: #131a22;
      font-size: 14px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://a0.awsstatic.com/libra-css/images/logos/aws_logo_smile_1200x630.png" alt="AWS Logo">
  </header>

  <h1>ðŸš€ Welcome to My AWS Practice Server Cloud Seeko!</h1>
  <p>This page is being served through <b>Nginx + PHP-FPM</b> running on an AWS EC2 Free Tier instance.</p>
  <p>The purpose of this server is purely for practice and learning, to better understand AWS services.</p>
  <p>Deployed by: <b>Suhyb</b></p>

  <a class="btn" href="https://docs.aws.amazon.com/" target="_blank">ðŸ“˜ Explore AWS Docs</a>

  <footer>
    Â© 2025 - AWS Practice Server
  </footer>
</body>
</html>
EOF

# Create PHP info test page
cat << 'EOF' > /usr/share/nginx/html/info.php
<?php
phpinfo();
?>
EOF

echo "âœ… NGINX + PHP setup complete. Access via http://<your-ec2-public-ip>/"
